---
title: "R Notebook"
output: html_notebook
---



```{r}
library(broom)
library(tidyverse)
library(car)
library(ggpubr)
library(lmtest)
library(DescTools)
library(patchwork)
library(corrplot)


setwd("/Users/phdwork/Dropbox/PhD/MAR20 WIP - Stat Modelling/2021 Analysis/")
`%notin%` = Negate(`%in%`)
calc_loocv_rmse = function(model) { sqrt(mean((resid(model) / (1 - hatvalues(model))) ^
2)) }

#Data for constitutive signalling (Fig 1)
ConstSig = read.csv("~/Dropbox/PhD/MAR20 WIP - Stat Modelling/2021 Analysis/Constituitive Signalling.csv")
ConstSig$Protein = gsub("pFgfr", "p-Fgfr", ConstSig$Protein)

#Data for signalling pathway cross talk (Fig 1)
CrossTalkDataNormToES = read.csv("~/Dropbox/PhD/MAR20 WIP - Stat Modelling/2021 Analysis/CrossTalkData_NormToES_Long.csv")

#Control data for Morphology (Fig 2)
Morph_Controls = read.csv("~/Dropbox/PhD/MAR20 WIP - Stat Modelling/2021 Analysis/Morph_Controls.csv")

#Data for models (Figs 2, 3, 4, S3, S4, S5, S7, S8, S9, S10)
AllVariables = read.csv("~/Dropbox/PhD/MAR20 WIP - Stat Modelling/2021 Analysis/StatModelPaper_AllData.csv")
AllVariables$Combo = paste(ifelse(AllVariables$U == 1,  "U", ""), ifelse(AllVariables$S == 1,  "S", ""),ifelse(AllVariables$L == 1,  "L", ""),ifelse(AllVariables$R == 1,  "R", ""),ifelse(AllVariables$P == 1,  "P", ""), sep="")
AllVariables$Combo = sapply(strsplit(AllVariables$Combo, ""), paste, collapse="+")
AllVariables$Combo <- sub("^$", "DMSO", AllVariables$Combo)
colnames(AllVariables)[1] = "Name"
colnames(AllVariables) = gsub("\\.", "", colnames(AllVariables))

#BRANN model outputs computed by Dave Winkler  (Figs 2, 3, 4, S3, S4, S5, S7, S8, S9, S10)
BRANN_AvP = read.csv("~/Dropbox/PhD/MAR20 WIP - Stat Modelling/All_BRANN_Results_FEB22.csv")

#Control data for emergent properties (Figs 3, S4)
EPLControlData = read.csv("~/Dropbox/PhD/MAR20 WIP - Stat Modelling/EPL Control Data - All Assays.csv")
EPLControlData$Exp = gsub("Cell Growth", "CellNoNorm",  EPLControlData$Exp)

#Control data for qPCR (Figs 4, S5)
EPLControlData_PCR = read.csv("~/Dropbox/PhD/MAR20 WIP - Stat Modelling/2021 Analysis/EPL and Cont PCR - All Days.csv")
EPLControlData_PCR = na.omit(EPLControlData_PCR)

#Data for functional assay (Fig S6)
FunctionalAssay = read.csv("~/Dropbox/PhD/MAR20 WIP - Stat Modelling/2021 Analysis/FunctionalAssay_Data.csv")
FunctionalAssay$X = NULL
FunctionalAssay = na.omit(FunctionalAssay)


#Colours for plots
ColourLinear = "#e07a5f" #Red
ColourTwoWay = "#3d405b" #Blue
ColourFiveWay = "#81b29a" #Green
ColourBRANN = "#f2cc8f" #Yellow
ColourHeatmapLow = "#81b29a" #Green
ColourHeatmapHigh = "#3D405b" #Blue
ColourHeatmapMid = "#FFFFFF" #White
ColourNeutral = "#e5e6e3" #Light Grey
```




########################### FIGURES ########################### 

#### FIGURE 1: Constituitive signalling and cross talk
```{r}
Figure1Plots = list()

####CONSTITUATIVE SIGNALLING
ConstSig2 = ConstSig

ConstSig2$Value = log2(ConstSig2$Value) ##### ADD LOG
ConstSig2$Time = factor(ConstSig2$Time, levels = c("0 h", "0.16 h", "0.5 h", "1 h", "2 h", "6 h", "12 h", "24 h", "48 h", "96 h", "144 h" ))
ConstSig2$Protein = factor(ConstSig2$Protein, levels = c("p-Stat3@Y705", "p-Stat3@S727", "p-Fgfr", "p-Erk1/2", "p-Akt", "p-S6k", "p-Rps6",     "p-4epb1"))

ConstSig_Recompile = as.data.frame(matrix(ncol=9, nrow=0))
colnames(ConstSig_Recompile) = c("Time", "Protein", "Mean", "stdev",  "se", "diff", "lwr.ci", "upr.ci", "pval")
 

for(Proteinz in c("p-4epb1", "p-Rps6", "p-S6k", "p-Akt", "p-Erk1/2", "p-Fgfr", "p-Stat3@S727", "p-Stat3@Y705")){
SubsDataForANOVA = subset(ConstSig2, ConstSig2$Protein %in% Proteinz)
SubsDataForTable = SubsDataForANOVA %>% group_by(Time, Protein) %>% dplyr::summarise(Mean = mean(Value), stdev = sd(Value), se=sd(Value)/sqrt(n())) 

ANOVAResTable = as.data.frame(DunnettTest(x=SubsDataForANOVA$Value, g=SubsDataForANOVA$Time)[[1]])
row.names(ANOVAResTable) = gsub("-0 h", "", row.names(ANOVAResTable))

SubsDataForTableWPval = merge(SubsDataForTable, ANOVAResTable, by.x = "Time", by.y = 0, all = T)
ConstSig_Recompile = rbind(ConstSig_Recompile, SubsDataForTableWPval)
}

ConstSig_Recompile$Sig <- ifelse(ConstSig_Recompile$pval <0.05,  "*", NA)

ConstSig_Recompile$Protein = factor(ConstSig_Recompile$Protein, levels = c("p-4epb1", "p-Rps6", "p-S6k", "p-Akt", "p-Erk1/2", "p-Fgfr", "p-Stat3@S727", "p-Stat3@Y705"))

Figure1Plots[["ConstSig"]] =  ggplot(ConstSig_Recompile, aes(x=Time, y=Protein, fill = Mean) )+ geom_tile(color = "grey") + coord_fixed() + scale_fill_gradient2(low = ColourHeatmapLow, mid = ColourHeatmapMid, high = ColourHeatmapHigh)+theme_classic() + theme(axis.ticks = element_blank(), axis.line = element_blank(), legend.title = element_blank(), plot.margin = margin(30,30,20,30, "pt")) + xlab("")+ geom_text(aes(label=Sig)) + ylab("") 


###### C: 2h panels
for(p in c("pERK", "pRPS6")){
if(p == "pERK"){p2 = "p-Erk1/2"}else{p2 = "p-Rps6"}
Reduced_phospho_2h0h = subset(CrossTalkDataNormToES, CrossTalkDataNormToES$Protein %in% p & CrossTalkDataNormToES$Time %in% c("2", "0"))
Reduced_phospho_2h0h$CondTime = paste(Reduced_phospho_2h0h$Inhib1, Reduced_phospho_2h0h$Time, sep="_")
Reduced_phospho_2h0h$CondTime = factor(Reduced_phospho_2h0h$CondTime, levels = c("NA_0", "NA_2", "U_2","S_2", "L_2", "R_2", "P_2"))
Reduced_phospho_2h0h$Value = log2(Reduced_phospho_2h0h$Value) ##### ADD LOG


Reduced_phospho_2h0h_Summ = Reduced_phospho_2h0h %>% group_by(Protein, Inhib1, Inhib2, Inhib_Dash, Time, CondTime) %>% dplyr::summarise(n = n(), Mean = mean(Value), stdev = sd(Value), se=sd(Value)/sqrt(n())) 

Reduced_phospho_2h0h[c("Inhib1")][is.na(Reduced_phospho_2h0h[c("Inhib1")])] <- "-"


ANOVARes = as.data.frame(DunnettTest(x=Reduced_phospho_2h0h$Value, g=Reduced_phospho_2h0h$CondTime)[1])
row.names(ANOVARes) = gsub("-NA_0", "", row.names(ANOVARes))

Reduced_phospho_2h0h_Summ = merge(Reduced_phospho_2h0h_Summ, ANOVARes, by.x = "CondTime", by.y = 0)
Reduced_phospho_2h0h_Summ$Inhib1[is.na(Reduced_phospho_2h0h_Summ$Inhib1)] <- "-"
Reduced_phospho_2h0h_Summ$Sig <- ifelse(Reduced_phospho_2h0h_Summ$NA_0.pval <0.05,  "*", NA)
Reduced_phospho_2h0h_Summ$Inhib1 = factor(Reduced_phospho_2h0h_Summ$Inhib1, levels = c("-", "U", "S", "L", "R", "P"))

Reduced_phospho_2h0h_Summ$Inhib1Wn = paste(Reduced_phospho_2h0h_Summ$Inhib1, "\n n=", Reduced_phospho_2h0h_Summ$n,  sep="")
Reduced_phospho_2h0h_Summ_merge = merge(Reduced_phospho_2h0h_Summ, Reduced_phospho_2h0h, by = "Inhib1")
Reduced_phospho_2h0h_Summ <- Reduced_phospho_2h0h_Summ[order(Reduced_phospho_2h0h_Summ$Inhib1),] 
Reduced_phospho_2h0h_Summ$Inhib1Wn = factor(Reduced_phospho_2h0h_Summ$Inhib1Wn, levels = Reduced_phospho_2h0h_Summ$Inhib1Wn)

if(p == "pERK"){SigLab = 2.5}else{SigLab = 1}

Figure1Plots[[paste("2h", p)]] = ggplot(Reduced_phospho_2h0h_Summ, aes(x=Inhib1Wn, y=Mean)) + geom_col(fill = ColourNeutral, color = "#000000", position = position_dodge(width = 0.9), width = 0.9)  +theme_classic() + geom_hline(yintercept=0)+ ylab(expression(Log[2]~fold~change)) + xlab("") + geom_errorbar(aes(ymin = Mean-se, ymax = Mean+se, ), position = position_dodge(width = 0.9), width = 0.2) + ggtitle(p2) + geom_point( aes(color = ColourTwoWay, shape = Sig, y = Mean + sign(Mean) * (se + (se+SigLab))), position = position_dodge(width = 0.9), size = 1, show.legend = F) + scale_shape_manual(values=c(8))+ theme( plot.title = element_text(size = 12, face = "bold", hjust = 0.5))   + geom_point(data=Reduced_phospho_2h0h_Summ_merge, aes(x = Inhib1Wn, y =Value), size=0.5) + scale_y_continuous(limits = c(min(Reduced_phospho_2h0h_Summ_merge$Value)*1.2, max(Reduced_phospho_2h0h_Summ_merge$Value)*1.1))
}
#axis.title.y = element_text(size = 10),  strip.text.x = element_text(size = 8),


####CROSS TALK PANELS
CrossTalkDataNormToES$Combo = paste(CrossTalkDataNormToES$Inhib1, CrossTalkDataNormToES$Inhib_Dash, sep=" ")
CrossTalkDataNormToES$Combo = gsub("NA", "-", CrossTalkDataNormToES$Combo)
CrossTalkDataNormToES$Combo = factor(CrossTalkDataNormToES$Combo, levels = c("- -", "U -", "U U", "S -", "S S", "L -", "L L", "R -", "R R", "P -", "P P", "U S", "U L", "U R", "U P", "R U", "R S", "R L", "R P"))

CrossTalk_Recompile = as.data.frame(matrix(ncol=11, nrow=0))
colnames(CrossTalk_Recompile) = c("Protein", "Inhib1", "Inhib2", "Inhib_Dash", "Time", "Combo", "Mean", "stdev", "se", "Pval_toPro", "Pval_toES")

for(Proteinz in c("pERK_Log", "pRPS6_Log")){
GoI = gsub("_.*", "", Proteinz)
CrossTalkInput = subset(CrossTalkDataNormToES, CrossTalkDataNormToES$Protein %in% GoI)
if(grepl("Log", Proteinz, fixed = TRUE) == T){
CrossTalkInput$Value = log2(CrossTalkInput$Value+0.01) ##### ADD LOG 
}  

for(Timez in c(4,6,8,10)){
for(Dataz in c("U -", "U U", "S -", "S S", "L -", "L L", "R -", "R R", "P -", "P P", "U S", "U L", "U R", "U P", "R U", "R S", "R L", "R P")){
SubsDataForANOVA = subset(CrossTalkInput, CrossTalkInput$Combo %in% c(Dataz, "- -") & CrossTalkInput$Time %in% Timez)

SubsDataForTable_All = subset(CrossTalkInput, CrossTalkInput$Combo %in% c(Dataz) & CrossTalkInput$Time %in% Timez & CrossTalkInput$Protein %in% GoI)

SubsDataForTable = SubsDataForTable_All %>% group_by(Protein, Inhib1, Inhib2, Inhib_Dash, Time, Combo) %>% dplyr::summarise(Mean = mean(Value), stdev = sd(Value), se=sd(Value)/sqrt(n())) 

ANOVARes = DunnettTest(x=SubsDataForANOVA$Value, g=SubsDataForANOVA$Combo)
ANOVARes2 = DunnettTest(x=c(SubsDataForTable_All$Value, rep(1, dim(SubsDataForTable_All)[1])), g=factor(c(SubsDataForTable_All$Combo, rep("Control", dim(SubsDataForTable_All)[1]))))


SubsDataForTable$Pval_toPro = ANOVARes[[1]][4]
SubsDataForTable$Pval_toES = ANOVARes2[[1]][4]

CrossTalk_Recompile = rbind(CrossTalk_Recompile, SubsDataForTable)
}}}


BottomPanels = list()
for(p in c("pERK", "pRPS6")){
if(p == "pERK"){p2 = "p-Erk1/2"}else{p2 = "p-Rps6"}
pERK_Controls = subset(CrossTalkDataNormToES, CrossTalkDataNormToES$Combo %in% "- -" & CrossTalkDataNormToES$Time %notin% c("0","2") & CrossTalkDataNormToES$Protein %in% p)
pERK_Controls_Sum = pERK_Controls %>% group_by(Protein, Inhib1, Inhib2, Inhib_Dash, Time, Combo) %>% dplyr::summarise(Mean = mean(Value), stdev = sd(Value), se=sd(Value)/sqrt(n())) 
pERK_Controls_Sum$Pval_toPro = NA
pERK_Controls_Sum$Pval_toES = NA


Reduced_pERK = subset(CrossTalk_Recompile, CrossTalk_Recompile$Protein %in% p & CrossTalk_Recompile$Time %notin% c("2", "0"))
Reduced_pERK = rbind(Reduced_pERK, pERK_Controls_Sum)
Reduced_pERK$Time = paste(Reduced_pERK$Time, "h")
Reduced_pERK$Time = factor(Reduced_pERK$Time, levels = c("10 h","8 h", "6 h", "4 h"))
Reduced_pERK$Combo = paste(Reduced_pERK$Inhib1, Reduced_pERK$Inhib_Dash, sep=" ")
Reduced_pERK$Combo = gsub("NA", "-", Reduced_pERK$Combo)
Reduced_pERK$Combo = factor(Reduced_pERK$Combo, levels = c("- -", "U -", "U U", "S -", "S S", "L -", "L L", "R -", "R R", "P -", "P P", "U S", "U L", "U R", "U P", "R U", "R S", "R L", "R P"))
levels(Reduced_pERK$Combo) <- gsub(" ", "\n", levels(Reduced_pERK$Combo))
Reduced_pERK$Sig <- ifelse(Reduced_pERK$Pval_toPro <0.05,  "*", NA)
BottomPanels[[paste("Cross Talk", p)]] = ggplot(Reduced_pERK, aes(x=Combo, y=Time, fill = Mean) )+ geom_tile(color = "grey") + coord_fixed()+ scale_x_discrete(labels = function(x) str_wrap(x, width = 1)) + scale_fill_gradient2(low = ColourHeatmapLow, mid = ColourHeatmapMid, high = ColourHeatmapHigh)+theme_classic() + theme(axis.ticks = element_blank(), axis.line = element_blank(), legend.title = element_blank(),  plot.title = element_text(size = 12, face = "bold", hjust = 0.5)) + xlab("") + geom_text(aes(label=Sig))+ ylab("") + ggtitle(p2)
}
CrossTalk_Recompile
Figure1Plots[["CrossTalk"]] = ggarrange(BottomPanels[[paste("Cross Talk", "pERK")]], BottomPanels[[paste("Cross Talk", "pRPS6")]])

Figure1Arrange = Figure1Plots[[1]] + Figure1Plots[[2]] + Figure1Plots[[3]] +Figure1Plots[[4]] + plot_layout(design ="##AAAB
##AAAC
DDDDDD",  widths = c(1,2), heights = c(1,1,2))

pdf("ModellingPaper_Figure1_l2.pdf", width = 15, height = 8)
print(Figure1Arrange)
dev.off()
```




###FIGURE 2, PANEL B: Correlation Plot
```{r}
SumForCorPlot = AllVariables %>% select(CellNoNorm_2, CellNoNorm_4, CellNoNorm_6, Prolif_2, Prolif_4, Prolif_6, Apoptosis_2,  Apoptosis_4, Apoptosis_6, Morphology, Rex1, Oct4, Dnmt3b, Fgf5, Mixl1 )
colnames(SumForCorPlot) = gsub("_", " - Day ", gsub("CellNoNorm", "Cell Number", gsub("Prolif", "Proliferation", colnames(SumForCorPlot))))


CORR = mycor(SumForCorPlot)


pdf("ModellingPaper_Figure3b_Correlation.pdf", width = 8, height = 6)
print(corrplot(corr=CORR$r, p.mat = CORR$p, method = "circle", type = "upper", order = "hclust", tl.col = "black", tl.srt = 45, tl.cex = 0.7, insig="label_sig", sig.level =.05, pch.cex = 1, col=colorRampPalette(c(ColourHeatmapLow,ColourHeatmapMid, ColourHeatmapHigh))(100)))
dev.off()


```



###FIGURE 2, PANEL C: Morphology
```{r}
Data_To_Plot = c("Morphology_Log") 
GEXPanel = list()
NRows = length(Data_To_Plot)

for(GoI_X in Data_To_Plot){
GoI = gsub("_.*", "", GoI_X)

########## PANEL I - CONTROLS ##########
Morph_Controls$Condition = factor(Morph_Controls$Condition, levels = c("1000 U/mL LIF", "330 U/mL LIF", "330 U/mL LIF + Pro", "0 U/mL LIF"))
ANOVAResTable = as.data.frame(DunnettTest(x=Morph_Controls$Value, g=Morph_Controls$Condition)[[1]])
row.names(ANOVAResTable) = gsub("-1000 U/mL LIF", "", row.names(ANOVAResTable))
ANOVAResTable$Sig <- ifelse(ANOVAResTable$pval <0.05,  "*", NA)


GoIControls_Summarised = Morph_Controls %>% group_by(Condition) %>% summarise(n = n(), Mean = mean(Value), stdev = sd(Value), se=sd(Value)/sqrt(n())) 
GoIControls_Summarised$Condition = factor(GoIControls_Summarised$Condition, levels = c("1000 U/mL LIF", "330 U/mL LIF", "330 U/mL LIF + Pro", "0 U/mL LIF"))

MorphwStats = merge(GoIControls_Summarised, ANOVAResTable,  by.x = "Condition", by.y = 0, all=T)
MorphwStats$ConditionWn = paste(MorphwStats$Condition, "\n n=", MorphwStats$n, sep="")
MorphwStats$ConditionWn = gsub("mL", "\nmL", gsub("LIF", "LIF\n", MorphwStats$ConditionWn))
Morph_Controls_merge = merge(MorphwStats, Morph_Controls, by = "Condition")
MorphwStats <- MorphwStats[order(MorphwStats$Condition),] 
MorphwStats$ConditionWn = factor(MorphwStats$ConditionWn, levels = MorphwStats$ConditionWn)

GEXPanel[[paste(GoI, "_i_Control", sep="")]] = ggplot(MorphwStats, aes(x=ConditionWn, y=Mean)) + geom_col(fill = ColourNeutral, color = "#000000", position = position_dodge(width = 0.9), width = 0.9)+ ggtitle(GoI) + theme_classic() + ylab("Morphology Score") + xlab("")+ geom_point( aes(colour = ColourTwoWay, shape = Sig, y = Mean + sign(Mean) * (se + (se*6))), position = position_dodge(width = 0.9), size = 1, show.legend = F) + geom_errorbar(aes(ymin = Mean-se, ymax = Mean+se), position = position_dodge(width = 0.9), width = 0.2) + scale_shape_manual(values=c(8))   + theme(plot.title = element_text(size = 15, face = "bold")) + scale_y_continuous(limits = c(0,2.2), expand = c(0,0))+ geom_point(data=Morph_Controls_merge, aes(x = ConditionWn, y =Value), size=0.5)


########## DATA PREP ##########
SingleMetric_AllData =  AllVariables[, c("Name", "Combo", "U", "S", "L", "R", "P", GoI)]
SingleMetric_AllData$Response = SingleMetric_AllData[[GoI]]
SingleMetric_AllData[[GoI]] = NULL
SingleMetric_AllData = na.omit(SingleMetric_AllData)

SingleMetric_AllData$Name = NULL
SingleMetric_AllData$Combo = paste("Day", SingleMetric_AllData$Day, "_", SingleMetric_AllData$Combo, sep="")
Reduced = SingleMetric_AllData %>% group_by(Combo) %>% summarise_all(funs(mean))

GetReps = as.data.frame(table(SingleMetric_AllData$Combo))
ThreePlusReps = subset(GetReps, GetReps$Freq >=3)
Reduced_ThreePlus = subset(Reduced, Reduced$Combo %in% ThreePlusReps$Var1)
##########


########## APPLY TRANSFORMATIONS IF REQUIRED ##########
if(GoI_X %notin% GoI){
#If log then  
if(grepl("Log", GoI_X, fixed = TRUE) == T){
if(min(Reduced_ThreePlus$Response) > 0){
Reduced_ThreePlus$Response = log(Reduced_ThreePlus$Response)  
}else{
Reduced_ThreePlus$Response = log(Reduced_ThreePlus$Response+1)  
}}
  
##If Power then
if(grepl("Power", GoI_X, fixed = TRUE) == T){
GetPower = extract_numeric(GoI_X)
Reduced_ThreePlus$Response = Reduced_ThreePlus$Response^GetPower
}

##If binned (each bin makes up a fixed % n, different no. samples in each bin)
if(grepl("Binned", GoI_X, fixed = TRUE) == T){
GetBins = extract_numeric(GoI_X)
Reduced_ThreePlus$Response = cut(Reduced_ThreePlus$Response, breaks = GetBins, labels = c(seq(1, GetBins, 1)))
Reduced_ThreePlus$Response = as.numeric(Reduced_ThreePlus$Response)
}    
##If Ntiled (each bin the same size)
if(grepl("Ntile", GoI_X, fixed = TRUE) == T){
GetNtile = extract_numeric(GoI_X)
Reduced_ThreePlus$Response = ntile(Reduced_ThreePlus$Response, GetNtile)
}      
}  
##########


########## RUN MODELS ##########
ModelList = list()
p2 = gsub(" ", "", gsub("-", "_", gsub(">=", "", GoI)))
ModelList[["Linear"]] = lm(Response~U+S+L+R+P, Reduced_ThreePlus)
ModelList[["Two Way"]] = lm(Response~(U+S+L+R+P)^2, Reduced_ThreePlus)
##########

########## PULL AVP, STATS AND COEFS ##########
AllAVP_GoI = as.data.frame(matrix(ncol = 10, nrow=0))
colnames(AllAVP_GoI) = c("Combo", "U", "S", "L", "R", "P", "Response", "Predicted", "ModelType", "Exp")

AllCoefs_GoI = as.data.frame(matrix(ncol = 8, nrow=0))
colnames(AllCoefs_GoI) = c("term", "estimate", "std.error", "statistic", "p.value", "Sig", "ModelType", "Exp")


ModelStats_GoI = as.data.frame(matrix(ncol = 19, nrow=0))
colnames(ModelStats_GoI) = c("r.squared", "adj.r.squared", "sigma", "statistic", "p.value", "df", "logLik", "AIC", "BIC", "deviance", "df.residual", "nobs", "NCV", "SW_Input", "SW_Residuals", "LOOCV", "BPTest", "ModelType", "Exp")


for(z in c("Linear", "Two Way")){
#AVP
GetPredicted = as.data.frame(ModelList[[z]]$fitted.values)
ActvPred = as.data.frame(cbind(Reduced_ThreePlus, GetPredicted$`ModelList[[z]]$fitted.values`))
colnames(ActvPred) = c(colnames(Reduced_ThreePlus), "Predicted")
ActvPred$ModelType = z
ActvPred$Exp = GoI
AllAVP_GoI = rbind(AllAVP_GoI, ActvPred)
write.csv(AllAVP_GoI, paste(GoI_X, "_3Models_AVP.csv", sep=""))

#COEFS
Coefs = tidy(ModelList[[z]])
Coefs = Coefs[-1, ] #####Remove Intercept
Coefs$term = gsub(":", "+", Coefs$term)
Coefs$term = factor(Coefs$term, levels=rev(Coefs$term))
Coefs$Sig <- ifelse(Coefs$p.value <0.05,  "*", NA)
Coefs$ModelType = z
Coefs$Exp = z
Coefs$term = factor(Coefs$term, levels = rev(Coefs$term))
AllCoefs_GoI = rbind(AllCoefs_GoI, Coefs)
write.csv(AllCoefs_GoI, paste(GoI_X, "_3Models_Coefs.csv", sep=""))


#Stats
Stats = glance(ModelList[[z]])
CheckNCV =  tryCatch(ncvTest(ModelList[[z]]), error=function(err) NA)
if(is.logical(CheckNCV)== T){Stats$NCV = "NA"}else{Stats$NCV = CheckNCV[[5]]}
Stats$SW_Input = shapiro.test(Reduced_ThreePlus$Response)[[2]]
CheckSWR =  tryCatch(shapiro.test(residuals(ModelList[[z]])), error=function(err) NA)
if(is.logical(CheckSWR)== T){Stats$SW_Residuals = "NA"}else{Stats$SW_Residuals = CheckSWR[[2]]}
Stats$LOOCV = calc_loocv_rmse(ModelList[[z]])
Stats$BPTest =  bptest(ModelList[[z]])[[4]]
Stats$ModelType = z
Stats$Exp = GoI
ModelStats_GoI = rbind(ModelStats_GoI, Stats)
write.csv(ModelStats_GoI, paste(GoI_X, "_3Models_Stats.csv", sep=""))
}
##########


########## PANEL II - AVP ##########    
PullBRANNData = subset(BRANN_AvP, BRANN_AvP$Exp %in% GoI_X)
PullAvP = AllAVP_GoI[, c("Response", "Predicted", "Exp", "ModelType")]
FourModels = rbind(PullBRANNData, PullAvP)

GEXPanel[[paste(GoI_X, "_ii_Models", sep="")]] = ggplot(FourModels, aes(x=Response, y=Predicted)) + geom_point(aes(color = ModelType)) + xlab("Actual") + theme_classic() + geom_smooth(aes(color = ModelType), method = lm, se = FALSE, fullrange = TRUE) + theme(legend.position="none", legend.title = element_blank()) + scale_color_manual(values = c(BRANN = ColourBRANN,  "Linear" = ColourLinear, "Two Way" = ColourTwoWay))

########## PANEL III - LINEAR COEFS ##########
GoI_Linear_Coefs = subset(AllCoefs_GoI, AllCoefs_GoI$ModelType %in% "Linear")
GoI_Linear_Coefs$term = factor(GoI_Linear_Coefs$term, levels = c("U", "S", "L", "R", "P"))

GEXPanel[[paste(GoI_X, "_iii_LinearCoefs", sep="")]] = ggplot(GoI_Linear_Coefs, aes(x=term, y=estimate)) + geom_col(fill = ColourLinear, color = "#000000", position = position_dodge(width = 0.9), width = 0.9)  +theme_classic() + geom_hline(yintercept=0)+ ylab("Coefficient") + xlab("") + geom_errorbar(aes(ymin = estimate-std.error, ymax = estimate+std.error, ), position = position_dodge(width = 0.9), width = 0.2) + ggtitle("") + geom_point( aes(shape = Sig, y = estimate + sign(estimate) * (std.error + (std.error*0.5))), position = position_dodge(width = 0.9), size = 1, show.legend = F) + scale_shape_manual(values=c(8))

########## PANEL IV - TWO-WAY COEFS ##########
GoI_TwoWay_Coefs = subset(AllCoefs_GoI, AllCoefs_GoI$ModelType %in% "Two Way")
GoI_TwoWay_Coefs$term = factor(GoI_TwoWay_Coefs$term, levels = c("U", "S", "L", "R", "P", "U+S", "U+L", "U+R", "U+P", "S+L", "S+R", "S+P", "L+R", "L+P", "R+P"))

GEXPanel[[paste(GoI_X, "_iii_TwoWayCoefs", sep="")]] = ggplot(GoI_TwoWay_Coefs, aes(x=term, y=estimate)) + geom_col(fill = ColourTwoWay, color = "#000000", position = position_dodge(width = 0.9), width = 0.9)  +theme_classic() + geom_hline(yintercept=0)+ ylab("Coefficient") + xlab("") + geom_errorbar(aes(ymin = estimate-std.error, ymax = estimate+std.error, ), position = position_dodge(width = 0.9), width = 0.2) + ggtitle("") + geom_point( aes(shape = Sig, y = estimate + sign(estimate) * (std.error + (std.error*0.5))), position = position_dodge(width = 0.9), size = 1, show.legend = F) + scale_shape_manual(values=c(8))
}

Figure3 = ggarrange(plotlist = GEXPanel, ncol = 4, widths = c(0.85,1.1,0.85,2))
pdf("ModellingPaper_Figure2.pdf", width = 15, height = NRows*4)
print(Figure3)
dev.off()
```


###FIGURE 3: 6 Coef Figures 
```{r}
#TRANSFORMATION OPTIONS
## Exp_Log - Logs data. If the data contains 0 then it will add 1 before logging.
## Exp_Power_n - Raises data to the power of n. Use 0.5 to get square root
## Exp_Binned_n - Categorized into bins of a fixed % of the distribution, different no. samples in each bin. n is the number of bins
## Exp_Ntile_n - Categorized into bins of a fixed % of the sample size, same no. samples in each bin. n is the number of bins
FontSizes = 8
#"CellNoNorm_Log", "CellNoNorm_Power_2", #, "Prolif", "CellNo.Norm", "Apoptosis

Data_To_Plot = c("CellNoNorm", "Apoptosis_Log", "Prolif_Power_6")# "CellNoNorm", "Apoptosis_Log", "Prolif_Power_6") 
GEXPanel = list()
FiveWaySupplemental = list()
NRows = length(Data_To_Plot)
for(GoI_X in Data_To_Plot){ 
GoI = gsub("_.*", "", GoI_X)
if(GoI == "Apoptosis"){
PlotTitle = "Apoptosis"
Control_Ylab = "% Annexin V+"
errormargin = 2.5
}
if(GoI == "Prolif"){
PlotTitle = "Proliferation"
Control_Ylab = "% BrdU +"
errormargin = 3

}
if(GoI == "CellNoNorm"){
PlotTitle = "Cell Number"
Control_Ylab = "Fold change"
errormargin = 2.8
}

########## PANEL I - CONTROLS ##########
GoIControls = subset(EPLControlData, EPLControlData$Exp %in% GoI)
GetMaxHeight = max(GoIControls$Value)*1.2
GEXPanel_Controls = list()

CompileData = as.data.frame(matrix(ncol =13, nrow=0))
colnames(CompileData) = c("Condition", "Day", "n", "Mean", "stdev", "se", "diff", "lwr.ci", "upr.ci", "pval", "Sig", "ConditionWn", "MaxHeight")

CompileData2 = as.data.frame(matrix(ncol =16, nrow=0))
colnames(CompileData2) = c("Condition", "Day.x", "n", "Mean", "stdev", "se", "diff", "lwr.ci", "upr.ci", "pval", "Sig", "ConditionWn", "Exp", "Day.y", "Value", "Day")

for(Dayz in c(2,4,6)){
EPLControlData_Subs = subset(GoIControls, GoIControls$Day %in% Dayz)
Control_GraphInputs = EPLControlData_Subs %>% group_by(Condition, Day) %>% summarise(n = n(), Mean = mean(Value), stdev = sd(Value), se=sd(Value)/sqrt(n()))

EPLControlData_Subs$Condition = factor(EPLControlData_Subs$Condition, levels = c("1000 U/mL LIF", "330 U/mL LIF", "330 U/mL LIF + Pro", "0 U/mL LIF"))
ANOVAResTable = as.data.frame(DunnettTest(x=EPLControlData_Subs$Value, g=EPLControlData_Subs$Condition)[[1]])
row.names(ANOVAResTable) = gsub("-1000 U/mL LIF", "", row.names(ANOVAResTable))
ANOVAResTable$Sig <- ifelse(ANOVAResTable$pval <0.05,  "*", NA)
SummedwStats = merge(Control_GraphInputs, ANOVAResTable,  by.x = "Condition", by.y = 0, all=T)

SummedwStats$ConditionWn = paste("D", SummedwStats$Day, "\n n=", SummedwStats$n,  sep="")
SummedwStats$ConditionWn = gsub("mL", "\nmL", gsub("LIF", "LIF\n", SummedwStats$ConditionWn))
EPLControlData_Subs_merge = merge(SummedwStats, EPLControlData_Subs, by = "Condition")

SummedwStats$Day = paste("Day", SummedwStats$Day)
SummedwStats$MaxHeight = (SummedwStats$Mean +  SummedwStats$se)
SummedwStats$Condition = factor(SummedwStats$Condition, levels = c("1000 U/mL LIF", "330 U/mL LIF", "330 U/mL LIF + Pro", "0 U/mL LIF"))
SummedwStats <- SummedwStats[order(SummedwStats$Condition),] 
CompileData = rbind(CompileData, SummedwStats)

EPLControlData_Subs_merge$Day = paste("Day", EPLControlData_Subs_merge$Day.x)
CompileData2 = rbind(CompileData2, EPLControlData_Subs_merge)

}

for(x in unique(CompileData$Condition)){
Subs = subset(CompileData, CompileData$Condition %in% x)
Subs$ConditionWn = factor(Subs$ConditionWn)
Subs2 = subset(CompileData2, CompileData2$Condition %in% x)
Subs2$ConditionWn = factor(Subs2$ConditionWn)
  
GEXPanel_Controls[[x]] = ggplot(Subs, aes(x=ConditionWn, y=Mean)) + geom_col(fill = ColourNeutral, color = "#000000", position = position_dodge(width = 0.9), width = 0.9)  +theme_classic()  + xlab("")+ geom_point(aes(colour = ColourTwoWay,  shape = Sig, y = Mean + sign(Mean) * (se + (se*errormargin))), position = position_dodge(width = 0.9), size = 1, show.legend = F) + geom_errorbar(aes(ymin = Mean-se, ymax = Mean+se), position = position_dodge(width = 0.9), width = 0.2) + scale_shape_manual(values=c(8)) + theme(plot.title = element_text(size = 15, face = "bold"), strip.background = element_blank(), strip.text.x = element_text(size = 12))  + scale_y_continuous(limits = c(0, GetMaxHeight), expand = c(0,0))  + scale_x_discrete(labels = Subs$ConditionWn) + geom_point(data=Subs2, aes(x = ConditionWn, y =Value), size=0.5) 
}

##




#CompileData$Condition = factor(CompileData$Condition, levels = c("1000 U/mL LIF", "330 U/mL LIF", "330 U/mL LIF + Pro", "0 U/mL LIF"))

#GEXPanel[[paste(GoI_X, "_i_Control", sep="")]] = ggplot(CompileData, aes(x=Day, y=Mean)) + facet_wrap(~Condition, nrow=1) + geom_col(fill = ColourNeutral, color = "#000000", position = position_dodge(width = 0.9), width = 0.9)  +theme_classic()  + xlab("")+ geom_point( aes(colour = ColourTwoWay,  shape = Sig, y = Mean + sign(Mean) * (se + (se*errormargin))), position = position_dodge(width = 0.9), size = 1, show.legend = F) + geom_errorbar(aes(ymin = Mean-se, ymax = Mean+se), position = position_dodge(width = 0.9), width = 0.2) + scale_shape_manual(values=c(8)) + theme( plot.title = element_text(size = 15, face = "bold"), strip.background = element_blank(), strip.text.x = element_text(size = 12))  + scale_y_continuous(limits = c(0, GetMaxHeight), expand = c(0,0))  + scale_x_discrete(labels = CompileData$ConditionWn) #
#}


GEXPanel_Controls[[1]] = GEXPanel_Controls[[1]] + ylab(Control_Ylab) + ggtitle("", subtitle = "1000 U/mL \nLIF") + theme(plot.subtitle = element_text(size = 10, face="italic"))
GEXPanel_Controls[[2]] = GEXPanel_Controls[[2]] + ggtitle("", subtitle = "330 U/mL LIF") + theme(axis.text.y = element_blank(), axis.line.y = element_blank(), axis.ticks.y = element_blank(), axis.title.y = element_blank()) + theme(plot.subtitle = element_text(size = 10, face="italic"))
GEXPanel_Controls[[3]] = GEXPanel_Controls[[3]] + ggtitle("", subtitle = "330 U/mL LIF  \n+ Pro")  + theme(axis.text.y = element_blank(), axis.line.y = element_blank(), axis.ticks.y = element_blank(), axis.title.y = element_blank())+ theme(plot.subtitle = element_text(size = 10, face="italic"))
GEXPanel_Controls[[4]] = GEXPanel_Controls[[4]] + ggtitle("", subtitle = "0 U/mL LIF" )  + theme(axis.text.y = element_blank(), axis.line.y = element_blank(), axis.ticks.y = element_blank(), axis.title.y = element_blank())+ theme(plot.subtitle = element_text(size = 10, face="italic"))

GEXPanel[[paste(GoI_X, "_i_Control", sep="")]] = ggarrange(plotlist =  GEXPanel_Controls, nrow=1, widths = c(1.3,1,1,1))

########## DATA PREP ##########
SingleMetric_AllData = as.data.frame(matrix(ncol=9, nrow=0))
colnames(SingleMetric_AllData) = c("Name", "Combo", "U", "S", "L", "R", "P", "Day", GoI)
for(x in c(2,4,6)){
SingleMetric_SingleDay = AllVariables[, c("Name", "Combo", "U", "S", "L", "R", "P", paste(GoI, x, sep="_"))]
SingleMetric_SingleDay$Day = x
colnames(SingleMetric_SingleDay) = gsub("_.*", "", colnames(SingleMetric_SingleDay))
SingleMetric_AllData = rbind(SingleMetric_AllData, SingleMetric_SingleDay)
}
SingleMetric_AllData = na.omit(SingleMetric_AllData)
SingleMetric_AllData$Name = NULL
SingleMetric_AllData$Response = SingleMetric_AllData[[GoI]]
SingleMetric_AllData[[GoI]] = NULL


SingleMetric_AllData$Combo = paste("Day", SingleMetric_AllData$Day, "_", SingleMetric_AllData$Combo, sep="")
Reduced = SingleMetric_AllData %>% group_by(Combo) %>% summarise_all(funs(mean))

Reduced$Day2 =  ifelse(Reduced$Day == 2,  1, 0)
Reduced$Day4 =  ifelse(Reduced$Day == 4,  1, 0)
Reduced$Day6 =  ifelse(Reduced$Day == 6,  1, 0)
Reduced$Day = NULL

GetReps = as.data.frame(table(SingleMetric_AllData$Combo))
ThreePlusReps = subset(GetReps, GetReps$Freq >=3)
Reduced_ThreePlus = subset(Reduced, Reduced$Combo %in% ThreePlusReps$Var1)
##########

########## APPLY TRANSFORMATIONS IF REQUIRED ##########
if(GoI_X %notin% GoI){
#If log then  
if(grepl("Log", GoI_X, fixed = TRUE) == T){
if(min(Reduced_ThreePlus$Response) > 0){
Reduced_ThreePlus$Response = log(Reduced_ThreePlus$Response)  
}else{
Reduced_ThreePlus$Response = log(Reduced_ThreePlus$Response+1)  
}}
  
##If Power then
if(grepl("Power", GoI_X, fixed = TRUE) == T){
GetPower = extract_numeric(GoI_X)
Reduced_ThreePlus$Response = Reduced_ThreePlus$Response^GetPower
}

##If binned (each bin makes up a fixed % n, different no. samples in each bin)
if(grepl("Binned", GoI_X, fixed = TRUE) == T){
GetBins = extract_numeric(GoI_X)
Reduced_ThreePlus$Response = cut(Reduced_ThreePlus$Response, breaks = GetBins, labels = c(seq(1, GetBins, 1)))
Reduced_ThreePlus$Response = as.numeric(Reduced_ThreePlus$Response)
}    
##If Ntiled (each bin the same size)
if(grepl("Ntile", GoI_X, fixed = TRUE) == T){
GetNtile = extract_numeric(GoI_X)
Reduced_ThreePlus$Response = ntile(Reduced_ThreePlus$Response, GetNtile)
}      
}  
##########

########## RUN MODELS ##########
ModelList = list()
p2 = gsub(" ", "", gsub("-", "_", gsub(">=", "", GoI)))
ModelList[["Linear"]] = lm(Response~U+S+L+R+P+Day2+Day4+Day6, Reduced_ThreePlus)
ModelList[["Two Way"]] = lm(Response~Day2+Day4+Day6+(U+S+L+R+P)^2, Reduced_ThreePlus)
ModelList[["Five Way"]] = lm(Response~Day2+Day4+Day6+(U+S+L+R+P)^5, Reduced_ThreePlus)
##########

########## PULL AVP, STATS AND COEFS ##########
AllAVP_GoI = as.data.frame(matrix(ncol = 13, nrow=0))
colnames(AllAVP_GoI) = c("Combo", "U", "S", "L", "R", "P", "Response", "Day2" , "Day4", "Day6", "Predicted", "ModelType", "Exp")

AllCoefs_GoI = as.data.frame(matrix(ncol = 8, nrow=0))
colnames(AllCoefs_GoI) = c("term", "estimate", "std.error", "statistic", "p.value", "Sig", "ModelType", "Exp")


ModelStats_GoI = as.data.frame(matrix(ncol = 19, nrow=0))
colnames(ModelStats_GoI) = c("r.squared", "adj.r.squared", "sigma", "statistic", "p.value", "df", "logLik", "AIC", "BIC", "deviance", "df.residual", "nobs", "NCV", "SW_Input", "SW_Residuals", "LOOCV", "BPTest", "ModelType", "Exp")


for(z in c("Linear", "Two Way", "Five Way")){
#AVP
GetPredicted = as.data.frame(ModelList[[z]]$fitted.values)
ActvPred = as.data.frame(cbind(Reduced_ThreePlus, GetPredicted$`ModelList[[z]]$fitted.values`))
colnames(ActvPred) = c(colnames(Reduced_ThreePlus), "Predicted")
ActvPred$ModelType = z
ActvPred$Exp = GoI
AllAVP_GoI = rbind(AllAVP_GoI, ActvPred)
write.csv(AllAVP_GoI, paste(GoI_X, "_3Models_AVP.csv", sep=""))

#COEFS
Coefs = tidy(ModelList[[z]])
Coefs = Coefs[-1, ] #####Remove Intercept
Coefs$term = gsub(":", "+", gsub("Day", "D", Coefs$term))
Coefs$Sig <- ifelse(Coefs$p.value <0.05,  "*", NA)
Coefs$ModelType = z
Coefs$Exp = z
AllCoefs_GoI = rbind(AllCoefs_GoI, Coefs)
write.csv(AllCoefs_GoI, paste(GoI_X, "_3Models_Coefs.csv", sep=""))


#Stats
Stats = glance(ModelList[[z]])
CheckNCV =  tryCatch(ncvTest(ModelList[[z]]), error=function(err) NA)
if(is.logical(CheckNCV)== T){Stats$NCV = "NA"}else{Stats$NCV = CheckNCV[[5]]}
Stats$SW_Input = shapiro.test(Reduced_ThreePlus$Response)[[2]]
CheckSWR =  tryCatch(shapiro.test(residuals(ModelList[[z]])), error=function(err) NA)
if(is.logical(CheckSWR)== T){Stats$SW_Residuals = "NA"}else{Stats$SW_Residuals = CheckSWR[[2]]}
Stats$LOOCV = calc_loocv_rmse(ModelList[[z]])
Stats$BPTest =  bptest(ModelList[[z]])[[4]]
Stats$ModelType = z
Stats$Exp = GoI
ModelStats_GoI = rbind(ModelStats_GoI, Stats)
write.csv(ModelStats_GoI, paste(GoI_X, "_3Models_Stats.csv", sep=""))
}
##########


########## PANEL II - AVP ##########    #Add BRANN
PullBRANNData = subset(BRANN_AvP, BRANN_AvP$Exp %in% GoI_X)
PullAvP = AllAVP_GoI[, c("Response", "Predicted", "Exp", "ModelType")]
FourModels = rbind(PullBRANNData, PullAvP)

GEXPanel[[paste(GoI_X, "_ii_Models", sep="")]] = ggplot(FourModels, aes(x=Response, y=Predicted)) + geom_point(aes(color = ModelType)) + xlab("Actual") + theme_classic() + geom_smooth(aes(color = ModelType), method = lm, se = FALSE, fullrange = TRUE) + theme(legend.position="none", legend.title = element_blank()) + scale_color_manual(values = c(BRANN = ColourBRANN, "Five Way" = ColourFiveWay, "Linear" = ColourLinear, "Two Way" = ColourTwoWay))


########## PANEL III - LINEAR COEFS ##########
GoI_Linear_Coefs = subset(AllCoefs_GoI, AllCoefs_GoI$ModelType %in% "Linear")
GoI_Linear_Coefs$term = factor(GoI_Linear_Coefs$term, levels = c("D2", "D4", "D6", "U", "S", "L", "R", "P"))

GEXPanel[[paste(GoI_X, "_iii_LinearCoefs", sep="")]] = ggplot(GoI_Linear_Coefs, aes(x=term, y=estimate)) + geom_col(fill = ColourLinear, color = "#000000", position = position_dodge(width = 0.9), width = 0.9)  +theme_classic() + geom_hline(yintercept=0)+ ylab("Coefficient") + xlab("") + geom_errorbar(aes(ymin = estimate-std.error, ymax = estimate+std.error, ), position = position_dodge(width = 0.9), width = 0.2) + ggtitle("") + geom_point( aes(shape = Sig, y = estimate + sign(estimate) * (std.error + (std.error*0.5))), position = position_dodge(width = 0.9), size = 1, show.legend = F) + scale_shape_manual(values=c(8))+ scale_x_discrete(labels = function(x) str_wrap(x, width = 3)) + theme(axis.text.x = element_text(size = FontSizes))

########## PANEL IV - TWO-WAY COEFS ##########
GoI_TwoWay_Coefs = subset(AllCoefs_GoI, AllCoefs_GoI$ModelType %in% "Two Way")
GoI_TwoWay_Coefs$term = factor(GoI_TwoWay_Coefs$term, levels = c("D2", "D4", "D6", "U", "S", "L", "R", "P", "U+S", "U+L", "U+R", "U+P", "S+L", "S+R", "S+P", "L+R", "L+P", "R+P"))

GEXPanel[[paste(GoI_X, "_iii_TwoWayCoefs", sep="")]] = ggplot(GoI_TwoWay_Coefs, aes(x=term, y=estimate)) + geom_col(fill = ColourTwoWay, color = "#000000", position = position_dodge(width = 0.9), width = 0.9)  +theme_classic() + geom_hline(yintercept=0)+ ylab("Coefficient") + xlab("") + geom_errorbar(aes(ymin = estimate-std.error, ymax = estimate+std.error, ), position = position_dodge(width = 0.9), width = 0.2) + ggtitle("") + geom_point( aes(shape = Sig, y = estimate + sign(estimate) * (std.error + (std.error*0.5))), position = position_dodge(width = 0.9), size = 1, show.legend = F) + scale_shape_manual(values=c(8))+ scale_x_discrete(labels = function(x) str_wrap(x, width = 3)) + theme(axis.text.x = element_text(size = FontSizes))


########## FOR SUPPLEMENTAL - FIVE-WAY COEFS ##########
GoI_FiveWay_Coefs = subset(AllCoefs_GoI, AllCoefs_GoI$ModelType %in% "Five Way")
GoI_FiveWay_Coefs$term = factor(GoI_FiveWay_Coefs$term, levels = c("D2", "D4", "D6", "U", "S", "L", "R", "P", "U+S", "U+L", "U+R", "U+P", "S+L", "S+R", "S+P", "L+R", "L+P", "R+P", "U+S+L", "U+S+R", "U+S+P", "U+L+R","U+L+P", "U+R+P", "S+L+R", "S+L+P", "S+R+P", "L+R+P", "U+S+L+R", "U+S+L+P", "U+S+R+P", "U+L+R+P", "S+L+R+P", "U+S+L+R+P"))

FiveWaySupplemental[[paste(GoI_X, "_FiveWayCoefs", sep="")]] = ggplot(GoI_FiveWay_Coefs, aes(x=term, y=estimate)) + geom_col(fill = ColourFiveWay, color = "#000000", position = position_dodge(width = 0.9), width = 0.9)  +theme_classic() + geom_hline(yintercept=0)+ ylab(Control_Ylab) + xlab("") + geom_errorbar(aes(ymin = estimate-std.error, ymax = estimate+std.error, ), position = position_dodge(width = 0.9), width = 0.2) + ggtitle("") + geom_point( aes(shape = Sig, y = estimate + sign(estimate) * (std.error + (std.error*0.5))), position = position_dodge(width = 0.9), size = 1, show.legend = F) + scale_shape_manual(values=c(8))+ theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), plot.title = element_text(size = 15, face = "bold")) + ggtitle(PlotTitle)

}

Figure3 = ggarrange(plotlist = GEXPanel, ncol = 4, nrow=NRows, widths = rep(c(1.6, 1, 0.85, 1.7), NRows))
pdf("ModellingPaper_Figure3_Run2.pdf", width = 15, height = NRows*4)
print(Figure3)
dev.off()


FiveWaySupplementalCombined = ggarrange(plotlist = FiveWaySupplemental, ncol = 1, nrow=NRows)
pdf("ModellingPaper_FiveWaySupplementalCombined.pdf", width = 15, height = NRows*5)
print(FiveWaySupplementalCombined)
dev.off()

if(Data_To_Plot == "Prolif_Ntile_8"){
AltModelForSup = ggarrange(plotlist = c(GEXPanel[2],GEXPanel[3],GEXPanel[4]), ncol = 3, nrow=NRows, widths = rep(c(1, 0.85, 1.7), NRows))
pdf("ModellingPaper_Supp4_Prolif_Ntile_8_NoControls.pdf", width = 15, height = NRows*4)
print(AltModelForSup)
dev.off()
}
```


###FIGURE 4: 5 Coef Figures
```{r}
Data_To_Plot = c("Rex1", "Oct4", "Dnmt3b", "Fgf5", "Mixl1") # # #"Lefty2", "Otx2"  #"Lefty2", "Otx2"
GEXPanel = list()
NRows = length(Data_To_Plot)

for(GoI in Data_To_Plot){
########## PANEL I - CONTROLS ##########
if("Lefty2" %in% Data_To_Plot){errormargin = 0.8}else{errormargin =1}


GoIControls = subset(EPLControlData_PCR, EPLControlData_PCR$Gene %in% GoI)
GetMaxHeight = max(GoIControls$Value)*1.3
GetMinHeight = min(GoIControls$Value)*1.4
GEXPanel_Controls = list()

for(Condit in c( "330 U/mL LIF", "330 U/mL LIF + Pro", "0 U/mL LIF")){
EPLControlData_Subs = subset(GoIControls, GoIControls$Condition %in% Condit)
ControlPCR_GraphInputs = EPLControlData_Subs %>% group_by(Condition, Day, Gene) %>% summarise(n = n(), Mean = mean(Value), stdev = sd(Value), se=sd(Value)/sqrt(n())) 

ControlGroup = as.data.frame(matrix(ncol = 0, nrow = max(as.data.frame(table(EPLControlData_Subs$Day))$Freq)))  
ControlGroup$Condition = Condit
ControlGroup$Gene = GoI
ControlGroup$Day = "Day 0"
ControlGroup$Value = 0

DataForANOVA = rbind(EPLControlData_Subs, ControlGroup)
DataForANOVA$Day = factor(DataForANOVA$Day, levels = c("Day 0", "Day 2", "Day 4", "Day 6"))
ANOVAResTable = as.data.frame(DunnettTest(x=DataForANOVA$Value, g=DataForANOVA$Day)[[1]])
row.names(ANOVAResTable) = gsub("-Day 0", "", row.names(ANOVAResTable))
ControlPCR_GraphInputsWPval = merge(ControlPCR_GraphInputs, ANOVAResTable, by.x = "Day", by.y = 0, all = T)
ControlPCR_GraphInputsWPval$Sig <- ifelse(ControlPCR_GraphInputsWPval$pval <0.05,  "*", NA)
ControlPCR_GraphInputsWPval$Day = gsub("Day ", "D", ControlPCR_GraphInputsWPval$Day)
ControlPCR_GraphInputsWPval$Day = factor(ControlPCR_GraphInputsWPval$Day, levels = c("D2", "D4", "D6"))
ControlPCR_GraphInputsWPval$DayWn = paste(ControlPCR_GraphInputsWPval$Day, "\n n=", ControlPCR_GraphInputsWPval$n, sep="")

EPLControlData_Subs$Day = gsub("Day ", "D", EPLControlData_Subs$Day)
EPLControlData_Subs$Day = factor(EPLControlData_Subs$Day, levels = c("D2", "D4", "D6"))

GEXPanel_Controls[[paste(Condit)]] = ggplot(ControlPCR_GraphInputsWPval, aes(x=Day, y=Mean))+ geom_col(fill = ColourNeutral, color = "#000000", position = position_dodge(width = 0.9), width = 0.9)  +theme_classic()  + xlab("")+ geom_point( aes(color = ColourTwoWay, shape = Sig, y = Mean  + sign(Mean) * (stdev + errormargin)), position = position_dodge(width = 0.9), size = 1, show.legend = F) + geom_errorbar(aes(ymin = Mean-se, ymax = Mean+se), position = position_dodge(width = 0.9), width = 0.2) + scale_shape_manual(values=c(8)) + theme(plot.subtitle = element_text(size = 12),  plot.title = element_text(size = 15, face = "bold"), strip.background = element_blank()) +geom_hline(yintercept=0) + scale_y_continuous(limits = c(GetMinHeight, GetMaxHeight), expand = c(0,0))  + scale_x_discrete(labels = ControlPCR_GraphInputsWPval$DayWn) + geom_point(data=EPLControlData_Subs, aes(x = Day, y =Value), size=0.5)
}

GEXPanel_Controls[[1]] = GEXPanel_Controls[[1]] + ylab(expression(Log[2]~Fold~Change)) + ggtitle(GoI, subtitle = "330 U/mL LIF") + theme(plot.subtitle = element_text(face = "italic", size = 11), plot.title = element_text(face = "bold.italic"))
GEXPanel_Controls[[2]] = GEXPanel_Controls[[2]] + ggtitle("", subtitle = "330 U/mL LIF \n+ Pro") + theme(axis.text.y = element_blank(), axis.line.y = element_blank(), axis.ticks.y = element_blank(), axis.title.y = element_blank()) + theme(plot.subtitle = element_text(face = "italic", size = 11))
GEXPanel_Controls[[3]] = GEXPanel_Controls[[3]] + ggtitle("", subtitle = "0 U/mL LIF")  + theme(axis.text.y = element_blank(), axis.line.y = element_blank(), axis.ticks.y = element_blank(), axis.title.y = element_blank())+ theme(plot.subtitle = element_text(face = "italic", size = 11))

GEXPanel[[paste(GoI, "_i_Controls", sep="")]] =  GEXPanel_Controls[[1]] + GEXPanel_Controls[[2]] + GEXPanel_Controls[[3]]
#######




########## DATA PREP ##########
SingleMetric_AllData =  AllVariables[, c("Name", "Combo", "U", "S", "L", "R", "P", GoI)]
SingleMetric_AllData$Response = SingleMetric_AllData[[GoI]]
SingleMetric_AllData[[GoI]] = NULL
SingleMetric_AllData = na.omit(SingleMetric_AllData)

SingleMetric_AllData$Name = NULL
SingleMetric_AllData$Combo = paste("Day", SingleMetric_AllData$Day, "_", SingleMetric_AllData$Combo, sep="")
Reduced = SingleMetric_AllData %>% group_by(Combo) %>% summarise_all(funs(mean))

GetReps = as.data.frame(table(SingleMetric_AllData$Combo))
ThreePlusReps = subset(GetReps, GetReps$Freq >=3)
ReducedData_ThreePlus = subset(Reduced, Reduced$Combo %in% ThreePlusReps$Var1)
##########

########## RUN MODELS ##########
ModelList = list()
p2 = gsub(" ", "", gsub("-", "_", gsub(">=", "", GoI)))
ModelList[["Linear"]] = lm(Response~U+S+L+R+P, ReducedData_ThreePlus)
ModelList[["Two Way"]] = lm(Response~(U+S+L+R+P)^2, ReducedData_ThreePlus)
##########

########## PULL AVP, STATS AND COEFS ##########
AllAVP_GoI = as.data.frame(matrix(ncol = 10, nrow=0))
colnames(AllAVP_GoI) = c("Combo", "U", "S", "L", "R", "P", "Response", "Predicted", "ModelType", "Exp")

AllCoefs_GoI = as.data.frame(matrix(ncol = 8, nrow=0))
colnames(AllCoefs_GoI) = c("term", "estimate", "std.error", "statistic", "p.value", "Sig", "ModelType", "Exp")


ModelStats_GoI = as.data.frame(matrix(ncol = 19, nrow=0))
colnames(ModelStats_GoI) = c("r.squared", "adj.r.squared", "sigma", "statistic", "p.value", "df", "logLik", "AIC", "BIC", "deviance", "df.residual", "nobs", "NCV", "SW_Input", "SW_Residuals", "LOOCV", "BPTest", "ModelType", "Exp")


for(z in c("Linear", "Two Way")){
#AVP
GetPredicted = as.data.frame(ModelList[[z]]$fitted.values)
ActvPred = as.data.frame(cbind(ReducedData_ThreePlus, GetPredicted$`ModelList[[z]]$fitted.values`))
colnames(ActvPred) = c(colnames(ReducedData_ThreePlus), "Predicted")
ActvPred$ModelType = z
ActvPred$Exp = GoI
AllAVP_GoI = rbind(AllAVP_GoI, ActvPred)
write.csv(AllAVP_GoI, paste(GoI, "_3Models_AVP.csv", sep=""))

#COEFS
Coefs = tidy(ModelList[[z]])
Coefs = Coefs[-1, ] #####Remove Intercept
Coefs$term = gsub(":", "+", Coefs$term)
Coefs$term = factor(Coefs$term, levels=rev(Coefs$term))
Coefs$Sig <- ifelse(Coefs$p.value <0.05,  "*", NA)
Coefs$ModelType = z
Coefs$Exp = z
Coefs$term = factor(Coefs$term, levels = rev(Coefs$term))
AllCoefs_GoI = rbind(AllCoefs_GoI, Coefs)
write.csv(AllCoefs_GoI, paste(GoI, "_3Models_Coefs.csv", sep=""))


#Stats
Stats = glance(ModelList[[z]])
CheckNCV =  tryCatch(ncvTest(ModelList[[z]]), error=function(err) NA)
if(is.logical(CheckNCV)== T){Stats$NCV = "NA"}else{Stats$NCV = CheckNCV[[5]]}
Stats$SW_Input = shapiro.test(ReducedData_ThreePlus$Response)[[2]]
CheckSWR =  tryCatch(shapiro.test(residuals(ModelList[[z]])), error=function(err) NA)
if(is.logical(CheckSWR)== T){Stats$SW_Residuals = "NA"}else{Stats$SW_Residuals = CheckSWR[[2]]}
Stats$LOOCV = calc_loocv_rmse(ModelList[[z]])
Stats$BPTest =  bptest(ModelList[[z]])[[4]]
Stats$ModelType = z
Stats$Exp = GoI
ModelStats_GoI = rbind(ModelStats_GoI, Stats)
write.csv(ModelStats_GoI, paste(GoI, "_3Models_Stats.csv", sep=""))
}
##########


########## PANEL II - AVP ##########    
PullBRANNData = subset(BRANN_AvP, BRANN_AvP$Exp %in% GoI)
PullAvP = AllAVP_GoI[, c("Response", "Predicted", "Exp", "ModelType")]
FourModels = rbind(PullBRANNData, PullAvP)

GEXPanel[[paste(GoI, "_ii_Models", sep="")]] = ggplot(FourModels, aes(x=Response, y=Predicted)) + geom_point(aes(color = ModelType)) + xlab("Actual") + theme_classic() + geom_smooth(aes(color = ModelType), method = lm, se = FALSE, fullrange = TRUE) + theme(legend.position="none", legend.title = element_blank()) + scale_color_manual(values = c(BRANN = ColourBRANN,  "Linear" = ColourLinear, "Two Way" = ColourTwoWay))

########## PANEL III - LINEAR COEFS ##########
GoI_Linear_Coefs = subset(AllCoefs_GoI, AllCoefs_GoI$ModelType %in% "Linear")
GoI_Linear_Coefs$term = factor(GoI_Linear_Coefs$term, levels = c("U", "S", "L", "R", "P"))

GEXPanel[[paste(GoI, "_iii_LinearCoefs", sep="")]] = ggplot(GoI_Linear_Coefs, aes(x=term, y=estimate)) + geom_col(fill = ColourLinear, color = "#000000", position = position_dodge(width = 0.9), width = 0.9)  +theme_classic() + geom_hline(yintercept=0)+ ylab("Coefficient") + xlab("") + geom_errorbar(aes(ymin = estimate-std.error, ymax = estimate+std.error, ), position = position_dodge(width = 0.9), width = 0.2) + ggtitle("") + geom_point( aes(shape = Sig, y = estimate + sign(estimate) * (std.error + (std.error*0.5))), position = position_dodge(width = 0.9), size = 1, show.legend = F) + scale_shape_manual(values=c(8))

########## PANEL IV - TWO-WAY COEFS ##########
GoI_TwoWay_Coefs = subset(AllCoefs_GoI, AllCoefs_GoI$ModelType %in% "Two Way")
GoI_TwoWay_Coefs$term = factor(GoI_TwoWay_Coefs$term, levels = c("U", "S", "L", "R", "P", "U+S", "U+L", "U+R", "U+P", "S+L", "S+R", "S+P", "L+R", "L+P", "R+P"))

GEXPanel[[paste(GoI, "_iii_TwoWayCoefs", sep="")]] = ggplot(GoI_TwoWay_Coefs, aes(x=term, y=estimate)) + geom_col(fill = ColourTwoWay, color = "#000000", position = position_dodge(width = 0.9), width = 0.9)  +theme_classic() + geom_hline(yintercept=0)+ ylab("Coefficient") + xlab("") + geom_errorbar(aes(ymin = estimate-std.error, ymax = estimate+std.error, ), position = position_dodge(width = 0.9), width = 0.2) + ggtitle("") + geom_point( aes(shape = Sig, y = estimate + sign(estimate) * (std.error + (std.error*0.5))), position = position_dodge(width = 0.9), size = 1, show.legend = F) + scale_shape_manual(values=c(8))
}


if("Lefty2" %in% Data_To_Plot){Name = "Supp5"}else{Name = "Figure4"}
Figure4 = ggarrange(plotlist = GEXPanel, ncol = 4, nrow=NRows, widths = rep(c(1.6, 1, 0.85, 1.7), NRows))
pdf(paste("ModellingPaper_", Name, ".pdf", sep= ""), width = 15, height = NRows*4)
print(Figure4)
dev.off()



```



### SUPPLEMENTAL 6: Functional Assay
```{r}
FA_list = list()
Condit = c("1000 U/mL LIF", "330 U/mL LIF + Pro", "U", "S", "L", "R", "P", "U+S", "U+L", "U+R", "U+P", "S+L", "S+R", "S+P", "L+P", "R+P", "U+S+L", "U+S+R", "U+R+P", "U+S+P","U+L+P", "S+L+P", "S+R+P", "U+S+R+P", "U+S+L+P")
#CompileForHeatmap = as.data.frame(matrix(ncol = 9, nrow = 0))
#colnames(CompileForHeatmap) = c("Day", "Condition", "Mean", "stdev", "se", "diff", "lwr.ci", "upr.ci", "pval" )

MaxVal = max(FunctionalAssay$Value) *1.1
MinVal = min(FunctionalAssay$Value)*1.1

for(x in Condit){
FA_ForSTATS = subset(FunctionalAssay, FunctionalAssay$Condition == x)

ControlGroup = as.data.frame(matrix(ncol = 0, nrow = max(as.data.frame(table(FA_ForSTATS$Day))$Freq)))  
ControlGroup$Condition = "Baseline"
ControlGroup$Day = "Day 0"
ControlGroup$Value = 0

CombineForDunnetts = rbind(FA_ForSTATS, ControlGroup)    
CombineForDunnetts$Day = factor(CombineForDunnetts$Day, levels = c("Day 0", "EB2", "EB3", "EB4"))

ANOVARes = as.data.frame(DunnettTest(x=CombineForDunnetts$Value, g=CombineForDunnetts$Day)[[1]])
row.names(ANOVARes) = gsub("-Day 0", "", row.names(ANOVARes))

CompileForPlot = FA_ForSTATS %>% group_by(Condition, Day) %>% summarise(n = n(), Mean = mean(Value), stdev = sd(Value), se=sd(Value)/sqrt(n())) 

CompileForPlotWStats = merge(CompileForPlot, ANOVARes, by.x = "Day", by.y = 0)
CompileForPlotWStats$Sig <- ifelse(CompileForPlotWStats$pval <0.05,  "*", NA)


CompileForPlotWStats$DayWn = paste(CompileForPlotWStats$Day, "\n n=", CompileForPlotWStats$n, sep="")
FA_ForSTATSmerge = merge(CompileForPlotWStats, FA_ForSTATS, by = "Day")

CompileForPlotWStats <- CompileForPlotWStats[order(CompileForPlotWStats$Day),] 
CompileForPlotWStats$DayWn = factor(CompileForPlotWStats$DayWn, levels = CompileForPlotWStats$DayWn)

if(x == "330 U/mL LIF + Pro"){Title = "330 U/mL LIF \n + Pro"}else{Title = x}

FA_list[[x]] = ggplot(CompileForPlotWStats, aes(x=DayWn, y=Mean))  + geom_col(fill = ColourTwoWay, color = "#000000")  +theme_classic() + geom_hline(yintercept=0) + ylab("") + xlab("") + geom_errorbar(aes(ymin = Mean-se, ymax = Mean+se), position = position_dodge(width = 0.9), width = 0.2) + theme(axis.text.x = element_text(size = 6), legend.position="none", plot.title = element_text(size = 10, face = "bold")) + scale_y_continuous(limits = c(MinVal, MaxVal)) + ggtitle(Title) + geom_point( aes(color = ColourTwoWay, shape = Sig, y = Mean + sign(Mean) * (se + (se*3.5))), position = position_dodge(width = 0.9), size = 1, show.legend = F) + scale_shape_manual(values=c(8)) + geom_point(data=FA_ForSTATSmerge, aes(x = DayWn, y =Value), size=0.5)

}      

FunctAssayFig = ggarrange(plotlist = FA_list, ncol =5, nrow=5)

pdf("Supplemental6_FunctionalAssay.pdf", width = 8, height =  9)
print(FunctAssayFig)
dev.off()
```




##Run Shapiro-Wilks test for BRANN
```{r}
SW_Res = as.data.frame(matrix(ncol=3, nrow=0))
colnames(SW_Res) = c("Exp", "SWpval", "Rsq")

for(x in unique(BRANN_AvP$Exp)){
Subs = subset(BRANN_AvP, BRANN_AvP$Exp == x)  
BRANN_SW = as.data.frame(x)
colnames(BRANN_SW) = "Exp"
BRANN_SW$SWpval =  shapiro.test(Subs$Predicted)[[2]]
GetLM = lm(Response~Predicted, data = Subs)
BRANN_SW$Rsq = glance(GetLM)[[1]]
SW_Res = rbind(SW_Res, BRANN_SW)
}
```



##All inhib - bar plots for supplementals
```{r}
SuppControlPCRFigs = list()
Data_To_Plot = c("Rex1", "Oct4", "Dnmt3b", "Fgf5", "Mixl1", "Lefty2", "Otx2", "Morphology")
NRows = length(Data_To_Plot)
for(e in Data_To_Plot){

if(e == "Morphology"){
Ytitle = "Morphology Score"
TitleStyle = "bold"}else{
Ytitle =expression(Log[2]~Fold~Change)
TitleStyle = "bold.italic"}  
  
SelectData = AllVariables[, c("Combo", e)]   
colnames(SelectData) = c("Combo", "Value")
SelectData = na.omit(SelectData)
SelectData_Condensed = SelectData %>% group_by(Combo) %>% summarise(n = n(), Mean = mean(Value), stdev = sd(Value), se=sd(Value)/sqrt(n()))
SelectData_Condensed_n3 = subset(SelectData_Condensed, SelectData_Condensed$n > 1)
SelectData_Condensed$Combo = factor(SelectData_Condensed$Combo, levels = c("DMSO", "U", "S", "L", "R", "P", "U+S", "U+L", "U+R", "U+P", "S+L", "S+R", "S+P", "L+R", "L+P", "R+P", "U+S+L", "U+S+R", "U+R+P", "U+S+P","U+L+P","S+L+R", "S+L+P", "S+R+P", "L+R+P", "U+S+R+P", "U+S+L+P", "U+S+L+R+P"))

ExclLR = subset(SelectData_Condensed,  SelectData_Condensed$Combo %notin% c("L+R", "U+L+R", "S+L+R", "L+R+P", "U+S+L+R",  "U+L+R+P", "S+L+R+P",  "U+S+L+R+P"))
SelectData_ExclLR = subset(SelectData,  SelectData$Combo %notin% c("L+R", "U+L+R", "S+L+R", "L+R+P", "U+S+L+R",  "U+L+R+P", "S+L+R+P",  "U+S+L+R+P"))

ExclLR$ComboWn = paste(ExclLR$Combo, " (n = ", ExclLR$n, ")", sep="")
SelectData_ExclLRmerge = merge(ExclLR, SelectData_ExclLR, by = "Combo")

ExclLR <- ExclLR[order(ExclLR$Combo),] 
ExclLR$ComboWn = factor(ExclLR$ComboWn, levels = ExclLR$ComboWn)


SuppControlPCRFigs[[e]] = ggplot(ExclLR, aes(x=ComboWn, y=Mean)) + geom_col(fill = ColourNeutral, color = "#000000")  +theme_classic() + geom_hline(yintercept=0) + ylab(Ytitle) + xlab("") + geom_errorbar(aes(ymin = Mean-se, ymax = Mean+se), position = position_dodge(width = 0.9), width = 0.2) + theme(legend.position="none", plot.title = element_text(size = 15, face = TitleStyle), axis.text.x = element_text( angle = 90, vjust = 0.5, hjust=1)) + ggtitle(e) + geom_point(data=SelectData_ExclLRmerge, aes(x = ComboWn, y =Value), size=0.5)
}

SuppPCR = ggarrange(plotlist = SuppControlPCRFigs, ncol = 1, nrow=NRows)
pdf("ModellingPaper_SuppPCR_AllCond.pdf", width = 12, height = NRows*2.8)
print(SuppPCR)
dev.off()


######################################
AllVariableswZeros = AllVariables

ExclLR_All = subset(AllVariableswZeros,  AllVariableswZeros$Combo %notin% c("L+R", "U+L+R", "S+L+R", "L+R+P", "U+S+L+R",  "U+L+R+P", "S+L+R+P",  "U+S+L+R+P"))  
OnlyLR_All = subset(AllVariableswZeros,  AllVariableswZeros$Combo %in% c("L+R", "U+L+R", "S+L+R", "L+R+P", "U+S+L+R",  "U+L+R+P", "S+L+R+P",  "U+S+L+R+P"))  
OnlyLR_All[c("CellNoNorm_2", "CellNoNorm_4", "CellNoNorm_6")][is.na(OnlyLR_All[c("CellNoNorm_2", "CellNoNorm_4", "CellNoNorm_6")])] <- 0

AllVariableswZeros = rbind(OnlyLR_All, ExclLR_All)

#
#
SuppControlEmergFigs = list()
Data_To_Plot = c("Prolif_2", "Prolif_4", "Prolif_6", "Apoptosis_2", "Apoptosis_4", "Apoptosis_6", "CellNoNorm_2", "CellNoNorm_4", "CellNoNorm_6")
for(e in Data_To_Plot){
if(grepl("Apoptosis", e, fixed = TRUE) == T){
PlotTitle = "Apoptosis"
Control_Ylab = "% Annexin V+"  
}
if(grepl("Prolif", e, fixed = TRUE)){
PlotTitle = "Proliferation"
Control_Ylab = "% BrdU +"
}
if(grepl("CellNoNorm", e, fixed = TRUE)){
PlotTitle = "Cell Number"
Control_Ylab = "Fold change"
}
if(grepl("Morphology", e, fixed = TRUE)){
PlotTitle = "Morphology"
Control_Ylab = "Morphology Score"
}
if(grepl("2", e, fixed = TRUE)){
DayFactor = " - Day 2"
}
if(grepl("4", e, fixed = TRUE)){
DayFactor = " - Day 4"
}
if(grepl("6", e, fixed = TRUE)){
DayFactor = " - Day 6"
}
  

SelectData = AllVariableswZeros[, c("Combo", e)]   
colnames(SelectData) = c("Combo", "Value")
SelectData = na.omit(SelectData)

SelectData_Condensed = SelectData %>% group_by(Combo) %>% summarise(n = n(), Mean = mean(Value), stdev = sd(Value), se=sd(Value)/sqrt(n()))
SelectData_Condensed$Combo = factor(SelectData_Condensed$Combo, levels = c("DMSO", "U", "S", "L", "R", "P", "U+S", "U+L", "U+R", "U+P", "S+L", "S+R", "S+P", "L+R", "L+P", "R+P", "U+S+L", "U+S+R","U+L+R", "U+R+P", "U+S+P","U+L+P","S+L+R", "S+L+P", "S+R+P", "L+R+P", "U+S+R+P", "U+S+L+R", "U+S+L+P", "U+L+R+P", "S+L+R+P",  "U+S+L+R+P"))



if(DayFactor == " - Day 2"){
ExclLR = subset(SelectData_Condensed,  SelectData_Condensed$Combo %notin% c("L+R", "U+L+R", "S+L+R", "L+R+P", "U+S+L+R",  "U+L+R+P", "S+L+R+P",  "U+S+L+R+P"))  
ExclLR$LRColour = "Neutral"
OnlyLR = subset(SelectData_Condensed,  SelectData_Condensed$Combo %in% c("L+R", "U+L+R", "S+L+R", "L+R+P", "U+S+L+R",  "U+L+R+P", "S+L+R+P",  "U+S+L+R+P"))  
OnlyLR$LRColour = "Blue"

SelectData_Condensed2 =rbind(ExclLR, OnlyLR)
SelectData_Condensed2$ComboWn = paste(SelectData_Condensed2$Combo, " (n = ", SelectData_Condensed2$n, ")", sep="")
SelectData_merge = merge(SelectData_Condensed2, SelectData, by = "Combo")
SelectData_Condensed2 <- SelectData_Condensed2[order(SelectData_Condensed2$Combo),] 
SelectData_Condensed2$ComboWn = factor(SelectData_Condensed2$ComboWn, levels = SelectData_Condensed2$ComboWn)


SuppControlEmergFigs[[e]] = ggplot(SelectData_Condensed2, aes(x=ComboWn, y=Mean,fill = LRColour)) + geom_bar(stat = "identity", color = "#000000") + scale_fill_manual(values = c("Neutral" =  ColourNeutral, "Blue" = ColourTwoWay))  +theme_classic() + geom_hline(yintercept=0) + ylab(Control_Ylab) + xlab("") + geom_errorbar(aes(ymin = Mean-se, ymax = Mean+se), position = position_dodge(width = 0.9), width = 0.2) + theme(legend.position="none", plot.title = element_text(size = 15, face = "bold"), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + ggtitle(paste(PlotTitle, DayFactor, sep = "")) + geom_point(data=SelectData_merge, aes(x = ComboWn, y =Value), color = "#000000", fill = "#000000", size = 0.5)

}else if(DayFactor == " - Day 4"){
ExclLR = subset(SelectData_Condensed,  SelectData_Condensed$Combo %notin% c("L+R", "U+L+R", "S+L+R", "L+R+P", "U+S+L+R",  "U+L+R+P", "S+L+R+P",  "U+S+L+R+P"))  
ExclLR$LRColour = "Neutral"
OnlyLR = subset(SelectData_Condensed,  SelectData_Condensed$Combo %in% c("L+R", "U+L+R", "S+L+R", "L+R+P", "U+S+L+R",  "U+L+R+P", "S+L+R+P",  "U+S+L+R+P"))  
OnlyLR$n = 0
OnlyLR$Mean = 0
OnlyLR$stdev = 0
OnlyLR$se = 0

OnlyLR$LRColour = "Blue"
SelectData_Condensed2 =rbind(ExclLR, OnlyLR)
SelectData_Condensed2$ComboWn = paste(SelectData_Condensed2$Combo, " (n = ", SelectData_Condensed2$n, ")", sep="")
SelectData_merge = merge(SelectData_Condensed2, SelectData, by = "Combo")
SelectData_merge$Value = ifelse(SelectData_merge$n == 0, 0, SelectData_merge$Value)

SelectData_Condensed2 <- SelectData_Condensed2[order(SelectData_Condensed2$Combo),] 
SelectData_Condensed2$ComboWn = factor(SelectData_Condensed2$ComboWn, levels = SelectData_Condensed2$ComboWn)


SuppControlEmergFigs[[e]] = ggplot(SelectData_Condensed2, aes(x=ComboWn, y=Mean,fill = LRColour)) + geom_bar(stat = "identity", color = "#000000") + scale_fill_manual(values = c("Neutral" =  ColourNeutral, "Blue" = ColourTwoWay))  +theme_classic() + geom_hline(yintercept=0) + ylab(Control_Ylab) + xlab("") + geom_errorbar(aes(ymin = Mean-se, ymax = Mean+se), position = position_dodge(width = 0.9), width = 0.2) + theme(legend.position="none", plot.title = element_text(size = 15, face = "bold"), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + ggtitle(paste(PlotTitle, DayFactor, sep = "")) + geom_point(data=SelectData_merge, aes(x = ComboWn, y =Value), color = "#000000", fill = "#000000", size = 0.5)

}else if(DayFactor == " - Day 6"){
ExclLR = subset(SelectData_Condensed,  SelectData_Condensed$Combo %notin% c("L+R", "U+L+R", "S+L+R", "L+R+P", "U+S+L+R",  "U+L+R+P", "S+L+R+P",  "U+S+L+R+P"))  
ExclLR$LRColour = "Neutral"
OnlyLR = subset(SelectData_Condensed,  SelectData_Condensed$Combo %in% c("L+R", "U+L+R", "S+L+R", "L+R+P", "U+S+L+R",  "U+L+R+P", "S+L+R+P",  "U+S+L+R+P"))  
OnlyLR$n = 0
OnlyLR$Mean = 0
OnlyLR$stdev = 0
OnlyLR$se = 0
OnlyLR$LRColour = "Blue"
SelectData_Condensed2 =rbind(ExclLR, OnlyLR)
SelectData_Condensed2$ComboWn = paste(SelectData_Condensed2$Combo, " (n = ", SelectData_Condensed2$n, ")", sep="")
SelectData_merge = merge(SelectData_Condensed2, SelectData, by = "Combo")
SelectData_merge$Value = ifelse(SelectData_merge$n == 0, 0, SelectData_merge$Value)
for(a in c("L+R", "U+L+R", "S+L+R", "L+R+P", "U+S+L+R",  "U+L+R+P", "S+L+R+P",  "U+S+L+R+P")){
if(!a %in% SelectData_merge$Combo){
ExtraData = as.data.frame(t(c(a, 0, 0, 0, 0, "Blue", paste(a, "(n=0)"), 0)))
colnames(ExtraData) = colnames(SelectData_merge)
ExtraData$Value = is.numeric(ExtraData$Value)
SelectData_merge = rbind(SelectData_merge, ExtraData)

ExtraData2 = as.data.frame(t(c(a, 0, 0, 0, 0, "Blue", paste(a, "(n=0)"))))
colnames(ExtraData2) = colnames(SelectData_Condensed2)
ExtraData2$Mean = is.numeric(ExtraData2$Mean)
ExtraData2$se = is.numeric(ExtraData2$se)
SelectData_Condensed2 = rbind(SelectData_Condensed2, ExtraData2)
}}
SelectData_Condensed2 <- SelectData_Condensed2[order(SelectData_Condensed2$Combo),] 
SelectData_Condensed2$ComboWn = factor(SelectData_Condensed2$ComboWn, levels = SelectData_Condensed2$ComboWn)

SuppControlEmergFigs[[e]] = ggplot(SelectData_Condensed2, aes(x=ComboWn, y=Mean,fill = LRColour)) + geom_bar(stat = "identity", color = "#000000") + scale_fill_manual(values = c("Neutral" =  ColourNeutral, "Blue" = ColourTwoWay))  +theme_classic() + geom_hline(yintercept=0) + ylab(Control_Ylab) + xlab("") + geom_errorbar(aes(ymin = Mean-se, ymax = Mean+se), position = position_dodge(width = 0.9), width = 0.2) + theme(legend.position="none", plot.title = element_text(size = 15, face = "bold"), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + ggtitle(paste(PlotTitle, DayFactor, sep = "")) + geom_point(data=SelectData_merge, aes(x = ComboWn, y =Value), color = "#000000", fill = "#000000", size = 0.5)

}
}

SuppEmerg = ggarrange(plotlist = SuppControlEmergFigs, ncol = 1, nrow=3)
pdf(paste("ModellingPaper_SuppEmerg_ExclLR.pdf", sep=""), width = 12, height = 3*2.8)
print(SuppEmerg)
dev.off()
```



### ITERATIONS FOR SUPP TABLE
```{r}
#################### 5 COEFS #################### 

Data_To_Plot = c("Morphology_Log", "Morphology", "Rex1", "Oct4", "Dnmt3b", "Fgf5", "Mixl1", "Lefty2", "Otx2") 
GEXPanel = list()
NRows = length(Data_To_Plot)

#GoI_X= c("Morphology_Log") 

for(GoI_X in Data_To_Plot){
GoI = gsub("_.*", "", GoI_X)

########## DATA PREP ##########
SingleMetric_AllData =  AllVariables[, c("Name", "Combo", "U", "S", "L", "R", "P", GoI)]
SingleMetric_AllData$Response = SingleMetric_AllData[[GoI]]
SingleMetric_AllData[[GoI]] = NULL
SingleMetric_AllData = na.omit(SingleMetric_AllData)

SingleMetric_AllData$Name = NULL
SingleMetric_AllData$Combo = paste("Day", SingleMetric_AllData$Day, "_", SingleMetric_AllData$Combo, sep="")
Reduced = SingleMetric_AllData %>% group_by(Combo) %>% summarise_all(funs(mean))

GetReps = as.data.frame(table(SingleMetric_AllData$Combo))
ThreePlusReps = subset(GetReps, GetReps$Freq >=3)
Reduced_ThreePlus = subset(Reduced, Reduced$Combo %in% ThreePlusReps$Var1)
##########


########## APPLY TRANSFORMATIONS IF REQUIRED ##########
if(GoI_X %notin% GoI){
#If log then  
if(grepl("Log", GoI_X, fixed = TRUE) == T){
if(min(Reduced_ThreePlus$Response) > 0){
Reduced_ThreePlus$Response = log(Reduced_ThreePlus$Response)  
}else{
Reduced_ThreePlus$Response = log(Reduced_ThreePlus$Response+1)  
}}
  
##If Power then
if(grepl("Power", GoI_X, fixed = TRUE) == T){
GetPower = extract_numeric(GoI_X)
Reduced_ThreePlus$Response = Reduced_ThreePlus$Response^GetPower
}

##If binned (each bin makes up a fixed % n, different no. samples in each bin)
if(grepl("Binned", GoI_X, fixed = TRUE) == T){
GetBins = extract_numeric(GoI_X)
Reduced_ThreePlus$Response = cut(Reduced_ThreePlus$Response, breaks = GetBins, labels = c(seq(1, GetBins, 1)))
Reduced_ThreePlus$Response = as.numeric(Reduced_ThreePlus$Response)
}    
##If Ntiled (each bin the same size)
if(grepl("Ntile", GoI_X, fixed = TRUE) == T){
GetNtile = extract_numeric(GoI_X)
Reduced_ThreePlus$Response = ntile(Reduced_ThreePlus$Response, GetNtile)
}      
}  
##########

### RANDOM TEST/TRAIN SPLITS
SummaryOutput = data.frame(matrix(ncol=6, nrow=0))
colnames(SummaryOutput) = c("Train_Rsq", "Train_SE", "Test_Rsq", "Test_SE",   "NSig", "SigCoefsTrain")
for(x in seq(1,50,1)){
  
  
RandomSplit= sample(1:dim(ThreePlusReps)[1], round(dim(ThreePlusReps)[1]*0.2), replace=FALSE)
DataTest = subset(Reduced_ThreePlus, row.names(Reduced_ThreePlus) %in% RandomSplit)
DataTrain = subset(Reduced_ThreePlus, row.names(Reduced_ThreePlus) %notin% RandomSplit)

##########

########## RUN MODELS ##########
ModelList = list()
p2 = gsub(" ", "", gsub("-", "_", gsub(">=", "", GoI)))
LinearTrain = lm(Response~U+S+L+R+P, DataTrain)
#ModelList[["Two Way"]] = lm(Response~(U+S+L+R+P)^2, DataTrain)
LinearTest = predict(LinearTrain, DataTest)
Model.testwdf = as.data.frame(cbind(DataTest$Response, LinearTest))
colnames(Model.testwdf) = c("Actual", "TestPred")
Modeltest_getRsq = lm(Actual~TestPred, Model.testwdf)

NSignif = data.frame(summary(LinearTrain)$coef)
NSignif = subset(NSignif, NSignif$Pr...t.. <0.05 & row.names(NSignif) %notin% "(Intercept)")
Colnames_Signif = paste(row.names(NSignif), collapse=", ")

TrainOutput = as.data.frame(cbind(summary(LinearTrain)$r.squared, summary(LinearTrain)$sigma,  summary(Modeltest_getRsq)$r.squared, summary(Modeltest_getRsq)$sigma,  dim(NSignif)[1], Colnames_Signif))
colnames(TrainOutput) = c("Train_Rsq", "Train_SE", "Test_Rsq", "Test_SE",   "NSig", "SigCoefsTrain")
SummaryOutput = rbind(SummaryOutput, TrainOutput)
}

SummaryOutput[1:4] = as.data.frame(apply(SummaryOutput[1:4], 2, as.numeric))

OutputMean = as.data.frame(t(colMeans(SummaryOutput[1:4])))
OutputMedians = as.data.frame(t(colMedians(as.matrix(SummaryOutput[1:4]))))
OutputMin = as.data.frame(t(apply(SummaryOutput,2,min)))
OutputMax = as.data.frame(t(apply(SummaryOutput,2,max)))

OutputMean$NSig = NA
OutputMean$SigCoefsTrain = NA
OutputMedians$NSig = NA
OutputMedians$SigCoefsTrain = NA
row.names(OutputMean) = "Mean"
row.names(OutputMedians) = "Median"
row.names(OutputMin) = "Min"
row.names(OutputMax) = "Max"

SummaryOutput = rbind(SummaryOutput, OutputMean, OutputMedians, OutputMin, OutputMax)
write.csv(SummaryOutput, paste(GoI_X, "_Iterations.csv", sep=""))
}






#################### 6 COEFS #################### 
Data_To_Plot = "Prolif" #c("Prolif_Ntile_8", "CellNoNorm", "Apoptosis_Log", "Prolif_Power_6", "Apoptosis") 
GEXPanel = list()
FiveWaySupplemental = list()
NRows = length(Data_To_Plot)
for(GoI_X in Data_To_Plot){ 
GoI = gsub("_.*", "", GoI_X)

########## DATA PREP ##########
SingleMetric_AllData = as.data.frame(matrix(ncol=9, nrow=0))
colnames(SingleMetric_AllData) = c("Name", "Combo", "U", "S", "L", "R", "P", "Day", GoI)
for(x in c(2,4,6)){
SingleMetric_SingleDay = AllVariables[, c("Name", "Combo", "U", "S", "L", "R", "P", paste(GoI, x, sep="_"))]
SingleMetric_SingleDay$Day = x
colnames(SingleMetric_SingleDay) = gsub("_.*", "", colnames(SingleMetric_SingleDay))
SingleMetric_AllData = rbind(SingleMetric_AllData, SingleMetric_SingleDay)
}
SingleMetric_AllData = na.omit(SingleMetric_AllData)
SingleMetric_AllData$Name = NULL
SingleMetric_AllData$Response = SingleMetric_AllData[[GoI]]
SingleMetric_AllData[[GoI]] = NULL


SingleMetric_AllData$Combo = paste("Day", SingleMetric_AllData$Day, "_", SingleMetric_AllData$Combo, sep="")
Reduced = SingleMetric_AllData %>% group_by(Combo) %>% summarise_all(funs(mean))

Reduced$Day2 =  ifelse(Reduced$Day == 2,  1, 0)
Reduced$Day4 =  ifelse(Reduced$Day == 4,  1, 0)
Reduced$Day6 =  ifelse(Reduced$Day == 6,  1, 0)
Reduced$Day = NULL

GetReps = as.data.frame(table(SingleMetric_AllData$Combo))
ThreePlusReps = subset(GetReps, GetReps$Freq >=3)
Reduced_ThreePlus = subset(Reduced, Reduced$Combo %in% ThreePlusReps$Var1)
##########

########## APPLY TRANSFORMATIONS IF REQUIRED ##########
if(GoI_X %notin% GoI){
#If log then  
if(grepl("Log", GoI_X, fixed = TRUE) == T){
if(min(Reduced_ThreePlus$Response) > 0){
Reduced_ThreePlus$Response = log(Reduced_ThreePlus$Response)  
}else{
Reduced_ThreePlus$Response = log(Reduced_ThreePlus$Response+1)  
}}
  
##If Power then
if(grepl("Power", GoI_X, fixed = TRUE) == T){
GetPower = extract_numeric(GoI_X)
Reduced_ThreePlus$Response = Reduced_ThreePlus$Response^GetPower
}

##If binned (each bin makes up a fixed % n, different no. samples in each bin)
if(grepl("Binned", GoI_X, fixed = TRUE) == T){
GetBins = extract_numeric(GoI_X)
Reduced_ThreePlus$Response = cut(Reduced_ThreePlus$Response, breaks = GetBins, labels = c(seq(1, GetBins, 1)))
Reduced_ThreePlus$Response = as.numeric(Reduced_ThreePlus$Response)
}    
##If Ntiled (each bin the same size)
if(grepl("Ntile", GoI_X, fixed = TRUE) == T){
GetNtile = extract_numeric(GoI_X)
Reduced_ThreePlus$Response = ntile(Reduced_ThreePlus$Response, GetNtile)
}      
}  
##########

### RANDOM TEST/TRAIN SPLITS
SummaryOutput = data.frame(matrix(ncol=6, nrow=0))
colnames(SummaryOutput) = c("Train_Rsq", "Train_SE", "Test_Rsq", "Test_SE",   "NSig", "SigCoefsTrain")
for(x in seq(1,50,1)){
  
  
RandomSplit= sample(1:dim(ThreePlusReps)[1], round(dim(ThreePlusReps)[1]*0.2), replace=FALSE)
DataTest = subset(Reduced_ThreePlus, row.names(Reduced_ThreePlus) %in% RandomSplit)
DataTrain = subset(Reduced_ThreePlus, row.names(Reduced_ThreePlus) %notin% RandomSplit)

##########

########## RUN MODELS ##########
ModelList = list()
p2 = gsub(" ", "", gsub("-", "_", gsub(">=", "", GoI)))
LinearTrain = lm(Response~U+S+L+R+P, DataTrain)
#ModelList[["Two Way"]] = lm(Response~(U+S+L+R+P)^2, DataTrain)
LinearTest = predict(LinearTrain, DataTest)
Model.testwdf = as.data.frame(cbind(DataTest$Response, LinearTest))
colnames(Model.testwdf) = c("Actual", "TestPred")
Modeltest_getRsq = lm(Actual~TestPred, Model.testwdf)

NSignif = data.frame(summary(LinearTrain)$coef)
NSignif = subset(NSignif, NSignif$Pr...t.. <0.05 & row.names(NSignif) %notin% "(Intercept)")
Colnames_Signif = paste(row.names(NSignif), collapse=", ")

TrainOutput = as.data.frame(cbind(summary(LinearTrain)$r.squared, summary(LinearTrain)$sigma,  summary(Modeltest_getRsq)$r.squared, summary(Modeltest_getRsq)$sigma,  dim(NSignif)[1], Colnames_Signif))
colnames(TrainOutput) = c("Train_Rsq", "Train_SE", "Test_Rsq", "Test_SE",   "NSig", "SigCoefsTrain")
SummaryOutput = rbind(SummaryOutput, TrainOutput)
}

SummaryOutput[1:4] = as.data.frame(apply(SummaryOutput[1:4], 2, as.numeric))

OutputMean = as.data.frame(t(colMeans(SummaryOutput[1:4])))
OutputMedians = as.data.frame(t(colMedians(as.matrix(SummaryOutput[1:4]))))
OutputMin = as.data.frame(t(apply(SummaryOutput,2,min)))
OutputMax = as.data.frame(t(apply(SummaryOutput,2,max)))

OutputMean$NSig = NA
OutputMean$SigCoefsTrain = NA
OutputMedians$NSig = NA
OutputMedians$SigCoefsTrain = NA
row.names(OutputMean) = "Mean"
row.names(OutputMedians) = "Median"
row.names(OutputMin) = "Min"
row.names(OutputMax) = "Max"

SummaryOutput = rbind(SummaryOutput, OutputMean, OutputMedians, OutputMin, OutputMax)
write.csv(SummaryOutput, paste(GoI_X, "_Iterations.csv", sep=""))
}
```







